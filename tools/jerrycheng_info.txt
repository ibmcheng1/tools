andy.yen@bcbssc.com
301-602-2248

//vi
http://www.lagmonster.org/docs/vi.html

helm ls --tls | grep poc | awk -f 'print $2'
helm ls --tls | awk '/poc/ {print $2}'

helm ls --deployed --namespace development --tls | awk '/poc/ {print $2}'

// workwd
helm ls --deployed --namespace development --tls | awk '/poc/ {print $1 ": " $2}'
helm ls --deployed --namespace ${p:icp.namespace} --tls | awk '/${p:helm.release}/ {print $1 ": " $2}'
helm ls --deployed --namespace ${p:icp.namespace} --tls | awk '/${p:helm.release}/ {print "Counter: " $2}'

helm ls --tls | awk '/poc/ {print $2}'

======================
helm ls --deployed --namespace ${p:icp.namespace} --tls | grep ${p:helm.release}

helm delete jenkinstest --purge --tls
==============================
// boot node
10.139.9.26
--------------------
Note: must sudo su -

--------------------
// proxy node
10.139.9.9

// edge browser.
// ICP admin console
https://10.139.9.10:8443/oidc/login.jsp

// UCD
https://10.139.9.9:31304/
admin / admin

// Jenkins
http://10.139.9.9:32046/login
admin / jAhn1V1lrW

// Git
https://github.com/ibmcheng1/tools/

https://git.bcbssc.com/login?return_to=https%3A%2F%2Fgit.bcbssc.com%2F
https://git.bcbssc.com/9Z60
https://git.bcbssc.com/xce1/jenkinstest
git@git.bcbssc.com:xce1/jenkinstest.git

https://git.bcbssc.com/BlueCrossBlueShieldSC/commercial-desktop

https://git.bcbssc.com/BenLink/jenkins-library-demo
https://git.bcbssc.com/BlueCrossBlueShieldSC/commercial-desktop-backend/tree/build/jenkinslibrary

https://git.bcbssc.com/BenLink/jenkins-library-demo

======================================
kubectl get pods | grep jenkinstest
kubectl logs jenkinstest-deployment-5cb99c78df-gcz4d --namespace development
kubectl delete pods jenkinstest-deployment-58855444b4-9jrhb --grace-period --force

def imageTag = "dc1cp01.icp:8500/jenkinstest/jenkinstest:${gitCommit}"  

=======================================
// How to pull DB2 image
=========================================
1. create  DB2 secret for docker registry
kubectl create secret docker-registry ibmcheng1 --docker-username=ibmcheng1 --docker-password=e4dfbed6-556c-4c25-bccf-8f0d99ef50f0 --docker-email=chengcc@hotmail.com --namespace=default
e4dfbed6-556c-4c25-bccf-8f0d99ef50f0

2. pull image into local, tag, then push to target ICP docker registry.
docker login --username ibmcheng1
docker pull store/ibmcorp/db2_developer_c:11.1.3.3a-x86_64

docker tag store/ibmcorp/db2_developer_c:11.1.3.3a-x86_64 dc1cp01.icp:8500/default/db2_developer_c:11.1.3.3a-x86_64

=> dc1cp01.icp:8500/default/db2_developer_c

// login to target ICP docker registry, and then push the image
// during DB2 install, the domain specific image should be used, and the secret is different.
docker login dc1cp01.icp:8500
// failed: docker push store/ibmcorp/db2_developer_c:11.1.3.3a-x86_64
docker push dc1cp01.icp:8500/default/db2_developer_c:11.1.3.3a-x86_64 

# Install
helm install --name db2ucd01 --namespace default 

# delete 
helm delete db2ucd01 --purge --tls

====================================
docker
=====================================
docker login dc1cp01.icp:8500
docker login dc1cp01.icp:8500/jenkinstest
docker image ls | grep jenkinstest

          
=====================================
Helm commands
=====================================
// boot node: 10.139.9.26
// user = a-9z59
// sudo su -

cd /tmp/helm-demo/jenkinstest/chart/jenkinstest

echo "1" | bx pr login -u admin -p admin --skip-ssl-validation

helm install --name jenkinstest -f ./values.yaml . --namespace development --tls --debug

helm upgrade --install jenkinstest -f ./values.yaml . --namespace development --tls --debug

helm delete jenkinstest --purge --tls

helm init --skip-refresh --client-only


cd /tmp/IBM/commercial-desktop-backend
helm upgrade --install cheng1-commercial-desktop-backend -f ./values.yaml . --namespace development --tls --debug
helm upgrade --install cheng1-commercial-desktop-backend -f ./values.yaml . --namespace development --tls

https://www.ibm.com/support/knowledgecenter/en/SSBS6K_2.1.0.2/getting_started/known_issues.html#helm_install
Helm CLI installation error
During the installation of the Helm Cli you might observe an error message that resembles the following output:
error copying from remote stream to local connection: readfrom tcp4 x.x.x.x>x.x.x.x write tcp4 x.x.x.x>x.x.x.x write: broken pipe
LAST DEPLOYED: Fri Feb 16 16:56:32 2018
NAMESPACE: default
STATUS: DEPLOYED




==========================================
helm upgrade --install -f ./values.yaml jenkinstest . --namespace development --tls --debug

==========================================
kubectl config set-cluster test.dc1-cp01.local --server=https://10.139.9.10:8001 --insecure-skip-tls-verify=true
kubectl config set-context test.dc1-cp01.local-context --cluster=test.dc1-cp01.local
kubectl config set-credentials admin --token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdF9oYXNoIjoiM2xubHIxN2h0Y3Qwa2Y2MWY2cG0iLCJyZWFsbU5hbWUiOiJjdXN0b21SZWFsbSIsInVuaXF1ZVNlY3VyaXR5TmFtZSI6ImFkbWluIiwiaXNzIjoiaHR0cHM6Ly9kYzFjcDAxLmljcDo5NDQzL29pZGMvZW5kcG9pbnQvT1AiLCJhdWQiOiI3ZWMwZDE0OTEyZTgxMDUyNmFhZTIwNTAzMGM1NmFjYyIsImV4cCI6MTUzMDI0Mjc4MSwiaWF0IjoxNTMwMjEzOTgxLCJzdWIiOiJhZG1pbiIsInRlYW1Sb2xlTWFwcGluZ3MiOltdfQ.dJowMjaZqnL3O95XEOlN9x6Y8442zYbkdEHGiVSRT_k0f25mnvIQZSp2QFwzKLWobZGi1RXSsF_dbK-X7CgOcLl0V1UyCp8cKa0keeFP9avc7adEEul94Ioj7SKtcBPOseefACKImfXO1LbsflRUk_oeMX2Pi5mSY1qmmboBZJJQomLQYKSMqe0Rvk1VULQh9aTtDcNDkSgs34qgnjQBlAVkbdHV7e2JbJYgIUHRcemFtdVV2wTRE293LRyAKblreiVbq5xv3hpzWKdRLvUKOlvs60SZHCwVtGj5jXBOBLbyhFT-XzVzI8VwWqV-zApS6vjxsmzro0yUuyBi9ozIfA
kubectl config set-context test.dc1-cp01.local-context --user=admin --namespace=development
kubectl config use-context test.dc1-cp01.local-context

kubectl config set-cluster test.dc1-cp01.local --server=https://10.139.9.10:8001 --insecure-skip-tls-verify=true
kubectl config set-context test.dc1-cp01.local-context --cluster=test.dc1-cp01.local
kubectl config set-credentials admin --token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdF9oYXNoIjoiaDMydmZ1MWducGVsbmE4dmw3NWgiLCJyZWFsbU5hbWUiOiJjdXN0b21SZWFsbSIsInVuaXF1ZVNlY3VyaXR5TmFtZSI6ImFkbWluIiwiaXNzIjoiaHR0cHM6Ly9kYzFjcDAxLmljcDo5NDQzL29pZGMvZW5kcG9pbnQvT1AiLCJhdWQiOiI3ZWMwZDE0OTEyZTgxMDUyNmFhZTIwNTAzMGM1NmFjYyIsImV4cCI6MTUzMDMwOTUxNiwiaWF0IjoxNTMwMjgwNzE2LCJzdWIiOiJhZG1pbiIsInRlYW1Sb2xlTWFwcGluZ3MiOltdfQ.nsxaWw8huSANEq3fKJ0tBrpWSZ-KTFddwTnN3Okkec6Bf5WaR2bVhZaeO2Wc4q3fknR5f6sypNKxX0YIxTlmuv2ShyxXtS61hYiigrmSUyvciq2VKOvenp0FuNQZn8F2oSAAOSLLM9ue02PjIDoUlYOKfZ5mF-3L71qcxx88VmSsYbTHwKywGiM1jThhOpd3AmY1UsNHGFmCJQ_84r-1mh_MqUTqpo5FdSrch-Ib5kEwPAy4mQMleMKLETsnvKAAtWySuiCK9rnvPPKS70FyzdadlCidxy5HD3JTOnPk8ppJx5iMRzqYaWy2s_rVowUehJpxXjLWE3sMNVY06VtcEw
kubectl config set-context test.dc1-cp01.local-context --user=admin --namespace=development
kubectl config use-context test.dc1-cp01.local-context
-------------------------------------------------------------------------------

// jenkinstest application URL

http://10.139.9.9:30233/jenkinstest
{"health":"http://10.139.9.9:30233/jenkinstest/health","example":"http://10.139.9.9:30233/jenkinstest/v1/example"}


def ucdComponent = 'JenkinsTest'
            def ucdApplication = 'jenkinstest'
            def ucdApplicationProcess = 'Deploy'
            def ucdEnvironment = 'ICP-DEV-POC'


'JenkinsTest:${BUILD_NUMBER}'

====================================
Github
=====================================
git clone https

======================================
[root@a70lscomibmc016:/root]# kubectl get pvc
NAME                  STATUS    VOLUME                                     CAPAC                                                      ITY   ACCESS MODES   STORAGECLASS                      AGE
bcbs-jenkins-01-pvc   Bound     pvc-a0f97f82-755d-11e8-aac3-005056919d65   12Gi                                                             RWO            cluster-shared-storage-retained   19d
bcbs-ucd62-01-app     Bound     pvc-75b192ac-8394-11e8-8759-00505691f7a0   20Gi                                                             RWO            cluster-shared-storage-retained   22h
bcbs-ucd62-01-ext     Bound     pvc-2ee9bb1e-7a38-11e8-a3c8-005056911d8c   2Gi                                                              RWO            cluster-shared-storage-retained   12d
db2ucd01-data         Bound     pvc-f0768f98-8381-11e8-8759-00505691f7a0   20Gi                                                             RWO            cluster-shared-storage-retained   1d
db2ucd01-data-stor    Bound     pvc-ae247c99-8381-11e8-8759-00505691f7a0   40Gi                                                             RWO            cluster-shared-storage-retained   1d
jenkins-maven         Bound     pvc-050f3cd7-844d-11e8-8759-00505691f7a0   10Gi                                                             RWX            cluster-shared-storage-retained   3m
z-jenkins-maven       Bound     nfs-pv2                                    2Gi                                                              RWO                                              19h
z-jenkins-pvc         Bound     nfs-pv1                                    12Gi                                                             RWO                                              19h


==============================
GlusterFS
===============================
Get the volume path
   Find the volume associated to the claim you are using
	kubectl get pvc
   Describe the volume, retrieving the path
	kubectl describe pv pvc-2ee9bb1e-7a38-11e8-a3c8-005056911d8c | grep Path
	kubectl describe pv pvc-f0768f98-8381-11e8-8759-00505691f7a0 | grep Path
		=> Path:           vol_47ca803a7c1b5d8c0d578b9d78723fa7
	kubectl describe pv pvc-ae247c99-8381-11e8-8759-00505691f7a0 | grep Path
		=> Path:           vol_7827ba9c3a1c3d766db18ca4f1d6be00


From a worker node with glusterfs-client installed
   ssh 10.139.9.24
   mkdir /tmp/jerry
   mount -t glusterfs 10.139.9.11,10.139.9.12,10.139.9.13:/vol_b0d1ffcfde2a2f42f5cadd01343bdbe5 /tmp/jerry
   mount -t glusterfs 10.139.9.11,10.139.9.12,10.139.9.13:/vol_47ca803a7c1b5d8c0d578b9d78723fa7 /tmp/jerry
   mount -t glusterfs 10.139.9.11,10.139.9.12,10.139.9.13:/vol_7827ba9c3a1c3d766db18ca4f1d6be00 /tmp/jerry


Copy the files into /tmp/jerry on the worker node 
Then unmount the volume from the worker node
   umount /tmp/jerry


=========================================
nodeSelector: sample
=========================================
"nodeSelector": {
          "beta.kubernetes.io/arch": "amd64"
        },
  


============================================
--namespace
${p:icp.namespace}
--install
--wait
--timeout
30
--tls
--debug
--------------------

plugin: Kubernetes, id: com.urbancode.air.plugin.kubernetes, version: 15
plugin command: '/opt/ibm-ucd/agent/opt/groovy-1.8.8/bin/groovy' '-cp' '/opt/ibm-ucd/agent/var/plugins/com.urbancode.air.plugin.kubernetes_15_8f85043a54c071d32eea56b813a06b3b99301985e66f12ccf96e4dd0a693ad13/classes:/opt/ibm-ucd/agent/var/plugins/com.urbancode.air.plugin.kubernetes_15_8f85043a54c071d32eea56b813a06b3b99301985e66f12ccf96e4dd0a693ad13/lib/uDeployRestClient.jar:/opt/ibm-ucd/agent/var/plugins/com.urbancode.air.plugin.kubernetes_15_8f85043a54c071d32eea56b813a06b3b99301985e66f12ccf96e4dd0a693ad13/lib/jettison-1.1.jar:/opt/ibm-ucd/agent/var/plugins/com.urbancode.air.plugin.kubernetes_15_8f85043a54c071d32eea56b813a06b3b99301985e66f12ccf96e4dd0a693ad13/lib/securedata.jar:/opt/ibm-ucd/agent/var/plugins/com.urbancode.air.plugin.kubernetes_15_8f85043a54c071d32eea56b813a06b3b99301985e66f12ccf96e4dd0a693ad13/lib/commons-codec.jar:/opt/ibm-ucd/agent/var/plugins/com.urbancode.air.plugin.kubernetes_15_8f85043a54c071d32eea56b813a06b3b99301985e66f12ccf96e4dd0a693ad13/lib/CommonsUtil.jar' '/opt/ibm-ucd/agent/var/plugins/com.urbancode.air.plugin.kubernetes_15_8f85043a54c071d32eea56b813a06b3b99301985e66f12ccf96e4dd0a693ad13/helm_upgrade.groovy' '/opt/ibm-ucd/agent/var/temp/logs2807273262340153425/input.props' '/opt/ibm-ucd/agent/var/temp/logs2807273262340153425/output.props'
working directory: /opt/ibm-ucd/agent/var/work/commercial-desktop-backend
properties:
  PLUGIN_INPUT_PROPS=/opt/ibm-ucd/agent/var/temp/logs2807273262340153425/input.props
  PLUGIN_OUTPUT_PROPS=/opt/ibm-ucd/agent/var/temp/logs2807273262340153425/output.props
  chart=./helm_chart
  flags=--namespace
development
--install
--wait
--timeout
30
--tls
--debug
  kubeconfig=/root/.kube/config
  path=
  release=poc-commercial-desktop-backend
environment:
  AGENT_HOME=/opt/ibm-ucd/agent
  AH_AUTH_TOKEN=****
  AH_WEB_URL=https://10.139.9.9:31304
  AUTH_TOKEN=****
  DS_AUTH_TOKEN=****
  DS_SYSTEM_ENCODING=UTF-8
  JAVA_OPTS=-Dfile.encoding=UTF-8 -Dconsole.encoding=UTF-8
  PLUGIN_HOME=/opt/ibm-ucd/agent/var/plugins/com.urbancode.air.plugin.kubernetes_15_8f85043a54c071d32eea56b813a06b3b99301985e66f12ccf96e4dd0a693ad13
  UCD_USE_ENCRYPTED_PROPERTIES=true
  UD_DIALOGUE_ID=381dc462-cb44-4c70-875b-45c4d86c45dc
  WE_ACTIVITY_ID=1648a2ee-1cda-87a0-04ca-b0f670424328
================================================================================
 
[action] Upgrading release poc-commercial-desktop-backend to chart ./helm_chart
command: helm upgrade poc-commercial-desktop-backend ./helm_chart --namespace development --install --wait --timeout 30 --tls --debug
[error]  Could not upgrade release poc-commercial-desktop-backend to chart ./helm_chart
E0711 12:32:13.534243   12399 portforward.go:303] error copying from remote stream to local connection: readfrom tcp4 127.0.0.1:40658->127.0.0.1:39154: write tcp4 127.0.0.1:40658->127.0.0.1:39154: write: broken pipe
 
 
##################################
Linux commands:
##################################
// Get string after character [duplicate]
// https://stackoverflow.com/questions/15148796/get-string-after-character
cut -d "/" -f 2 <<< "$your_str"

cut -d "/" -f 2 <<< "build/jenkinslibrary"

---
rc=`cut -d. -f1 <<< ${p:Get Component Version/version.name} 2>&1`

rc=`cut -d "/" -f 2 <<< "${rc}" 2>&1`
// or
rc=`echo "${rc}" | sed -r 's/[/]+/-/g' 2>&1`
----
// test scenario 1:
rc=`cut -d. -f1 <<< build/jenkinslibrary.82 2>&1`
-> build/jenkinslibrary
rc=`cut -d "/" -f 2 <<< "${rc}" 2>&1`
-> jenkinslibrary
----

// test scenario 2:
rc=`cut -d. -f1 <<< build/jenkinslibrary.82 2>&1`
-> build/jenkinslibrary 
rc=`echo "${rc}" | sed -r 's/[/]+/-/g' 2>&1`
-> build-jenkinslibrary
-------------------
// ensure less than 53 characters
cut -c-53 <<< ${data}
-------------------------

echo "build/jenkinslibrary" | sed -r 's/[/]+/-/g'
echo $rc
===========================================
// replace upper case with lower case in a String
echo "$a" | tr '[:upper:]' '[:lower:]'

=================================
      
// Get string before character [duplicate], e.g. .
cut -d. -f1 <<< "$your_str"
rc=`cut -d. -f1 <<< ${p:Get Component Version/version.name} 2>&1`

=====================================
commercial-desktop-backend-dev-build/jenkinslibrary
command output: 
Component Version Name = build/jenkinslibrary.82
Git Branch = build/jenkinslibrary
Helm release = commercial-desktop-backend-dev-build/jenkinslibrary
[debug] Created tunnel using local port: '43386'
 
[debug] SERVER: "127.0.0.1:43386"
 
[debug] Key="/root/.helm/key.pem", Cert="/root/.helm/cert.pem", CA="/root/.helm/ca.pem"
 
Error: UPGRADE FAILED: invalid release name, must match regex ^(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])+$ and the length must not longer than 53
===============================
command exit code: 1

=================================
===============================
command output: 
Environment Name = Dev
Component Name = commercial-desktop-backend
Component Version Name = build/jenkinslibrary.82
temporary rc = build/jenkinslibrary
Git Branch = build-jenkinslibrary
Old Helm release = commercial-desktop-backend-dev-build-jenkinslibrary
New Helm release = commercial-desktop-backend-Dev-build-jenkinslibrary
[debug] Created tunnel using local port: '45084'
 
[debug] SERVER: "127.0.0.1:45084"
 
[debug] Key="/root/.helm/key.pem", Cert="/root/.helm/cert.pem", CA="/root/.helm/ca.pem"
 
Release "commercial-desktop-backend-Dev-build-jenkinslibrary" does not exist. Installing it now.
[debug] CHART PATH: /opt/ibm-ucd/agent/var/work/commercial-desktop-backend/helm_chart
 
Error: release commercial-desktop-backend-Dev-build-jenkinslibrary failed: Service "commercial-desktop-backend-Dev-build-jenkinslibrary-commercial" is invalid: metadata.name: Invalid value: "commercial-desktop-backend-Dev-build-jenkinslibrary-commercial": a DNS-1035 label must consist of lower case alphanumeric characters or '-', start with an alphabetic character, and end with an alphanumeric character (e.g. 'my-name',  or 'abc-123', regex used for validation is '[a-z]([-a-z0-9]*[a-z0-9])?')
===============================

No version for that component exists for that resource
#echo "Component Version Name = ${p:Get Component Version/version.name}"
================================

helm ls --deployed --tls | grep commercial

data=commercial-desktop-backend-system-build-jenkinslibrary

cut -c-53 <<< ${data}